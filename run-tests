#!/bin/bash


BASE_DIR="$(dirname $BASH_SOURCE)"
TEST_DONE=0


install_deployer () {
    dpkg-deb --build $BASE_DIR/deployer \
      && sudo dpkg --install $BASE_DIR/deployer.deb
}


get_tests_paths () {
  find $BASE_DIR/tests -type f -executable | sort -n
}


test_done () {
    echo "OK";
    TEST_DONE=$(($TEST_DONE + 1));
}


run_test () {
    rm -rf /tmp/test-deployer;
    mkdir  /tmp/test-deployer;
    cd     /tmp/test-deployer;

    printf "$1 : "

    $1 > /dev/null \
      && test_done \
      || echo "Error [$?]";
}


install_deployer > /dev/null || exit 255;


for test_path in $(get_tests_paths); 
do
    run_test $test_path;
done;


echo "";
echo "======================================================";
echo "Done. Ran $TEST_DONE tests.";
